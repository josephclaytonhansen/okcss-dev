import db from"./src/server/mongo.js";import express from"express";const app=express();import nunjucks from"nunjucks";import rate_limit from"express-rate-limit";const router=express.Router();import axios from"axios";import upload from"./src/server/multerStorage.js";import page_routes from"./src/server/routes/pageRoutes.min.js";import post_routes from"./src/server/routes/postRoutes.min.js";import user_routes from"./src/server/routes/userRoutes.min.js";import comment_routes from"./src/server/routes/commentRoutes.min.js";import category_routes from"./src/server/routes/categoriesRoutes.min.js";import session from"express-session";import passport from"passport";import"./src/server/passportSetup.js";app.use(session({secret:process.env.SESSION_SECRET,resave:!1,saveUninitialized:!0,cookie:{secure:"production"==process.env.ENV},store:db.sessionStore})),app.use(passport.session()),app.use(passport.initialize());import cors from"cors";import fs from"fs";import dotenv from"dotenv";dotenv.config(),app.use(express.json()),app.use(express.urlencoded({extended:!1}));const corsOptions={origin:process.env.ORIGIN,credentials:!0,optionSuccessStatus:200};app.use(cors(corsOptions)),app.options("*",cors(corsOptions)),nunjucks.configure(["src/views","src/includes","src/assets"],{autoescape:!0,express:app,watch:!0});const limiter=rate_limit({windowMs:9e5,max:400,standardHeaders:!0,legacyHeaders:!1});"production"==process.env.ENV&&app.use(limiter),app.use("/page",page_routes),app.use("/post",post_routes),app.use("/user",user_routes),app.use("/comment",comment_routes),app.use("/category",category_routes),router.get("/",((s,e)=>{e.redirect("/login")})),router.get("/postFunctions.js",((s,e)=>{e.type("js"),e.sendFile("/src/assets/js/postFunctions.min.js",{root:"."})})),router.get("/edit/post/:id",(async(s,e)=>{const t=s.params.id;let r=[];const o=await axios.get("http://localhost:5920/category/").then((s=>s.data));for(let s=0;s<o.length;s++)r.push(o[s].name);let a=await axios.get("http://localhost:5920/post/").then((s=>s.data)),i=[];for(let s=0;s<a.length;s++)i.push(a[s]._id);let n=i.indexOf(t);-1==n?e.redirect("/dashboard"):e.render("editor.html",{root:".",post:await axios.get("http://localhost:5920/post/id/"+i[n]).then((s=>s.data)),type:"post",user:{email:"served_from@express.app",username:"served_from_express"},all_categories:r})})),router.get("/edit/page/:id",(async(s,e)=>{const t=s.params.id;let r=[];const o=await axios.get("http://localhost:5920/category/").then((s=>s.data));for(let s=0;s<o.length;s++)r.push(o[s].name);let a=await axios.get("http://localhost:5920/page/").then((s=>s.data)),i=[];for(let s=0;s<a.length;s++)i.push(a[s]._id);let n=i.indexOf(t);-1==n?e.redirect("/dashboard"):e.render("editor.html",{root:".",post:await axios.get("http://localhost:5920/page/id/"+i[n]).then((s=>s.data)),type:"page",user:{email:"served_from@express.app",username:"served_from_express"},all_categories:r})})),router.get("/editor.js",((s,e)=>{e.type("js"),e.sendFile("/src/views/js/editor.min.js",{root:"."})})),router.get("/editor.css",((s,e)=>{e.type("css"),e.sendFile("/src/views/css/editor.min.css",{root:"."})})),router.get("/login",((s,e)=>{e.render("login.html",{root:"."})})),router.get("/login.css",((s,e)=>{e.type("css"),e.sendFile("/src/views/css/login.min.css",{root:"."})})),router.get("/dashboard",(async(s,e)=>{const t=await axios.get("http://localhost:5920/category/").then((s=>s.data));let r=[];for(let s=0;s<t.length;s++)r.push(t[s].name);const o=await axios.get("http://localhost:5920/user/").then((s=>s.data));let a=[];for(let s=0;s<o.length;s++)a.push({name:o[s].display_name,id:o[s]._id});e.render("dashboard.html",{root:".",date:{day:(new Date).getDate(),month:(new Date).getMonth(),monthName:(new Date).toLocaleString("default",{month:"long"}),year:(new Date).getFullYear()},user:{email:"served_from@express.app",username:"served_from_express"},all_authors:a,all_categories:t,current_categories:r,posts:await axios.get("http://localhost:5920/post").then((s=>s.data)),pages:await axios.get("http://localhost:5920/page").then((s=>s.data)),upcoming_posts:await axios.get("http://localhost:5920/post/upcoming").then((s=>s.data)).catch((s=>[]))})})),router.get("/account",((s,e)=>{const t={day:(new Date).getDate(),month:(new Date).getMonth(),monthName:(new Date).toLocaleString("default",{month:"long"}),year:(new Date).getFullYear()};e.render("account.html",{root:".",user:{email:"served_from@express.app",username:"served_from_express",password:"password",picture:"https://unsplash.it/1000/450/?random?",bio:"I am a user served from express. This is my bio. As a placeholder, I have little else to say.",display_name:"Served F. Express"},date:t})})),router.get("/account.css",((s,e)=>{e.type("css"),e.sendFile("/src/views/css/account.min.css",{root:"."})})),router.get("/dashboard.css",((s,e)=>{e.type("css"),e.sendFile("/src/views/css/dashboard.min.css",{root:"."})})),router.get("/calendar.css",((s,e)=>{e.type("css"),e.sendFile("/src/views/css/calendar.min.css",{root:"."})})),router.get("/history_compare.css",((s,e)=>{e.type("css"),e.sendFile("/src/includes/css/history_compare.min.css",{root:"."})})),router.get("/image_upload.css",((s,e)=>{e.type("css"),e.sendFile("/src/includes/css/image_upload.min.css",{root:"."})})),router.get("/stats.css",((s,e)=>{e.type("css"),e.sendFile("/src/includes/css/stats.min.css",{root:"."})})),router.get("/stats.js",((s,e)=>{e.type("js"),e.sendFile("/src/includes/js/stats.min.js",{root:"."})})),router.get("/calendar.js",((s,e)=>{e.type("js"),e.sendFile("/src/includes/js/calendar.min.js",{root:"."})})),router.get("/blog_sidebar.js",((s,e)=>{e.type("js"),e.sendFile("/src/includes/js/blog_sidebar.min.js",{root:"."})})),router.get("/history_compare.js",((s,e)=>{e.type("js"),e.sendFile("/src/includes/js/history_compare.min.js",{root:"."})})),router.get("/dashboard.js",((s,e)=>{e.type("js"),e.sendFile("/src/views/js/dashboard.min.js",{root:"."})})),router.get("/img/gallery.js",((s,e)=>{e.type("js"),e.sendFile("/src/views/js/utils/imgs/gallery.min.js",{root:"."})})),router.get("/colors.js",((s,e)=>{e.type("js"),e.sendFile("/src/views/js/utils/colors/color.min.js",{root:"."})})),router.get("/img/list.js",((s,e)=>{e.type("js"),e.sendFile("/src/views/js/utils/imgs/img_list.min.js",{root:"."})})),router.get("/img/upload.js",((s,e)=>{e.type("js"),e.sendFile("/src/views/js/utils/imgs/upload.min.js",{root:"."})})),router.get("/app.css",((s,e)=>{e.type("css"),e.sendFile("/src/assets/css/app.min.css",{root:"."})})),router.get("/lightbox-modal.css",((s,e)=>{e.type("css"),e.sendFile("/src/assets/css/lightbox-modal.min.css",{root:"."})})),router.get("/image/gallery.css",((s,e)=>{e.type("css"),e.sendFile("/src/assets/css/img-gallery-list-view.min.css",{root:"."})})),router.get("/admin_toolbar.css",((s,e)=>{e.type("css"),e.sendFile("/src/includes/css/admin_toolbar.min.css",{root:"."})})),router.get("/admin_toolbar.js",((s,e)=>{e.type("js"),e.sendFile("/src/includes/js/admin_toolbar.min.js",{root:"."})})),router.get("/post_list.js",((s,e)=>{e.type("js"),e.sendFile("/src/includes/js/post_list.min.js",{root:"."})})),router.get("/post_list.css",((s,e)=>{e.type("css"),e.sendFile("/src/includes/css/post_list.min.css",{root:"."})})),router.get("/sidebar.css",((s,e)=>{e.type("css"),e.sendFile("/src/includes/css/sidebar.min.css",{root:"."})})),router.get("/word_count.css",((s,e)=>{e.type("css"),e.sendFile("/src/includes/css/word_count.min.css",{root:"."})})),router.get("/header.css",((s,e)=>{e.type("css"),e.sendFile("/src/includes/css/header.min.css",{root:"."})})),router.get("/icons/style.css",((s,e)=>{e.type("text/css"),e.sendFile("src/assets/lucide/css/l.min.css",{root:"."})})),router.get("/icons/:icon",((s,e)=>{e.type("image/svg+xml");const t=s.params.icon;e.sendFile("src/assets/lucide/used/"+t+".svg",{root:"."})})),router.get("/new-post",(async(s,e)=>{let t=[];const r=await axios.get("http://localhost:5920/category/").then((s=>s.data));for(let s=0;s<r.length;s++)t.push(r[s].name);e.render("editor.html",{root:".",post:{title:"Untitled Post",meta_title:"",meta_description:"",meta_keywords:[],author:"",slug:"",content:"",categories:[],tags:[],scheduled_date:"",status:"draft",featured_image:""},type:"post",user:{email:"served_from@express.app",username:"served_from_express"},all_categories:t})})),router.get("/new-page",(async(s,e)=>{e.render("editor.html",{root:".",post:{title:"Untitled Page",meta_title:"",meta_description:"",meta_keywords:[],author:"",slug:"",content:"",status:"draft"},type:"page",user:{email:"served_from@express.app",username:"served_from_express"}})})),router.post("/upload-image",upload.single("streamfile"),((s,e)=>{if(s.fileValidationError)return e.status(400).json({message:s.fileValidationError});const t=s.file;return t?e.status(201).json({name:t.filename,path:t.path,size:t.size,type:t.type,width:t.width,height:t.height,createdAt:t.createdAt,updatedAt:t.updatedAt,alt:t.alt_text}):e.status(400).json({message:"Please upload a file"})})),app.use("/",router),app.listen(5920,(()=>{}));