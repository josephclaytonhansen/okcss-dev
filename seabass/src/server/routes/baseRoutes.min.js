import axios from"axios";import User from"../models/userModel.min.js";import Post from"../models/postModel.min.js";import fs from"fs";import{populate,populateNew}from"./utils/populate.min.js";import express from"express";const router=express.Router();router.get("/dashboard",(async(e,t)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let s=await populate(e,t).then((e=>e)),o=[];if(e.session.thumbnails)o=e.session.thumbnails;else{let t=[];await axios.get("http://localhost:5920/uploaded-media-thumbnails").then((e=>{t=e.data.slugs}));for(let e=0;e<t.length;e++)await axios.get("http://localhost:5920/uploaded-media/"+t[e]).then((e=>{o.push(e.data)}));e.session.thumbnails=o}t.render("dashboard.html",{root:".",user:s.user,posts:s.posts,pages:s.pages,comments:s.comments,all_authors:s.all_authors,all_categories:s.all_categories,cached_media:o,date:{day:(new Date).getDate(),month:(new Date).getMonth(),monthName:(new Date).toLocaleString("default",{month:"long"}),year:(new Date).getFullYear()}})}else t.redirect("/login-na")})),router.get("/account",(async(e,t)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let s=await populate(e,t).then((e=>e)),o=[],a=[];User.findById(s.user).then((e=>{const r={day:(new Date).getDate(),month:(new Date).getMonth(),monthName:(new Date).toLocaleString("default",{month:"long"}),year:(new Date).getFullYear()};a=s.posts.filter((t=>t.author==e._id)),o=s.pages.filter((t=>t.author==e._id)),t.render("account.html",{root:".",user:s.user,date:r,posts:a,pages:o,all_authors:s.all_authors,all_categories:s.all_categories})}))}else t.redirect("/login-na")})),router.get("/new-post",(async(e,t)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let s=await populateNew(e,t).then((e=>e));t.render("editor.html",{root:".",post:{title:"Untitled Post",meta_title:"",meta_description:"",meta_keywords:[],author:"",slug:"",content:"",categories:[],tags:[],scheduled_date:"",status:"draft",featured_image:"",history:[]},type:"post",user:s.user,all_categories:s.all_categories,all_authors:s.all_authors})}else t.redirect("/login-na")})),router.get("/new-page",(async(e,t)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let s=await populateNew(e,t).then((e=>e));t.render("editor.html",{root:".",post:{title:"Untitled Page",meta_title:"",meta_description:"",meta_keywords:[],author:"",slug:"",content:"",categories:[],tags:[],scheduled_date:"",status:"draft",featured_image:"",history:[]},type:"page",user:s.user,all_categories:s.all_categories,all_authors:s.all_authors})}else t.redirect("/login-na")})),router.get("/edit/post/:id",(async(e,t)=>{e.session.passport&&"worm"!=e.session.passport.permissions||t.redirect("/login-na")})),router.get("/edit/page/:id",(async(e,t)=>{e.session.passport&&"worm"!=e.session.passport.permissions||t.redirect("/login-na")}));export default router;