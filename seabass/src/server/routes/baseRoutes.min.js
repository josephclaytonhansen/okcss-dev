import axios from"axios";import User from"../models/userModel.min.js";import fs from"fs";import express from"express";const router=express.Router();router.get("/dashboard",(async(e,s)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let t=e.session.passport.user,a=null;if(e.session.user)a=e.session.user;else{let s=await User.findById(t).then((e=>e));e.session.user=s}let o=null,n=null;e.session.categories?(o=e.session.categories,n=o.map((e=>({name:e.name,id:e._id})))):(o=await axios.get("http://localhost:5920/category/"),e.session.categories=o.data,n=o.data.map((e=>({name:e.name,id:e._id}))));let i=null;e.session.posts?i=e.session.posts:(i=await axios.get("http://localhost:5920/post/"),e.session.posts=i.data);let r=null;e.session.pages?r=e.session.pages:(r=await axios.get("http://localhost:5920/page/"),e.session.pages=r.data);let l=null;e.session.comments?l=e.session.comments:(l=await axios.get("http://localhost:5920/comment/"),e.session.comments=l.data);let d=null,p=null;e.session.users?(d=e.session.users,p=d.map((e=>({name:e.display_name,id:e._id})))):(d=await axios.get("http://localhost:5920/user/"),e.session.users=d.data,p=d.data.map((e=>({name:e.display_name,id:e._id}))));let m=[];if(e.session.thumbnails)m=e.session.thumbnails;else{let s=[];await axios.get("http://localhost:5920/uploaded-media-thumbnails").then((e=>{s=e.data.slugs}));for(let e=0;e<s.length;e++)await axios.get("http://localhost:5920/uploaded-media/"+s[e]).then((e=>{m.push(e.data)}));e.session.thumbnails=m}s.render("dashboard.html",{root:".",user:a,posts:i,pages:r,comments:l,all_authors:p,all_categories:n,cached_media:m,date:{day:(new Date).getDate(),month:(new Date).getMonth(),monthName:(new Date).toLocaleString("default",{month:"long"}),year:(new Date).getFullYear()}})}else s.redirect("/login-na")})),router.get("/account",((e,s)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let t=e.session.passport.user;User.findById(t).then((t=>{User.findById(e.session.passport.user).then((e=>{const t={day:(new Date).getDate(),month:(new Date).getMonth(),monthName:(new Date).toLocaleString("default",{month:"long"}),year:(new Date).getFullYear()};s.render("account.html",{root:".",user:e,date:t})})).catch((e=>{s.redirect("/login")}))})).catch((e=>{s.redirect("/login")}))}else s.redirect("/login-na")})),router.get("/new-post",(async(e,s)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let t=e.session.passport.user;User.findById(t).then((e=>{let t=[];const a=axios.get("http://localhost:5920/category/").then((e=>e.data));let o=axios.get("http://localhost:5920/user/").then((e=>e.data.map((e=>({name:e.display_name,id:e._id})))));for(let e=0;e<a.length;e++)t.push(a[e].name);s.render("editor.html",{root:".",post:{title:"Untitled Post",meta_title:"",meta_description:"",meta_keywords:[],author:"",slug:"",content:"",categories:[],tags:[],scheduled_date:"",status:"draft",featured_image:""},type:"post",user:e,all_categories:t,all_authors:o})})).catch((e=>{s.redirect("/login")}))}else s.redirect("/login-na")})),router.get("/new-page",(async(e,s)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let t=e.session.passport.user,a=axios.get("http://localhost:5920/user/").then((e=>e.data.map((e=>({name:e.display_name,id:e._id})))));User.findById(t).then((e=>{s.render("editor.html",{root:".",post:{title:"Untitled Page",meta_title:"",meta_description:"",meta_keywords:[],author:"",slug:"",content:"",status:"draft"},type:"page",user:e,all_authors:a})})).catch((e=>{s.redirect("/login")}))}else s.redirect("/login-na")}));export default router;