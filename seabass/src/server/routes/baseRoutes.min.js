import axios from"axios";import User from"../models/userModel.min.js";import Post from"../models/postModel.min.js";import fs from"fs";import{populate,populateNew}from"./utils/populate.min.js";import express from"express";const router=express.Router();router.get("/dashboard",(async(e,s)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let t=await populate(e,s).then((e=>e)),o=[];if(e.session.thumbnails)o=e.session.thumbnails;else{let s=[];await axios.get("http://localhost:5920/uploaded-media-thumbnails").then((e=>{s=e.data.slugs}));for(let e=0;e<s.length;e++)await axios.get("http://localhost:5920/uploaded-media/"+s[e]).then((e=>{o.push(e.data)}));e.session.thumbnails=o}s.render("dashboard.html",{root:".",user:t.user,posts:t.posts,pages:t.pages,comments:t.comments,all_authors:t.all_authors,all_categories:t.all_categories,cached_media:o,date:{day:(new Date).getDate(),month:(new Date).getMonth(),monthName:(new Date).toLocaleString("default",{month:"long"}),year:(new Date).getFullYear()}})}else s.redirect("/login-na")})),router.get("/account",(async(e,s)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let t=await populate(e,s).then((e=>e)),o=[],a=[];User.findById(t.user).then((e=>{const r={day:(new Date).getDate(),month:(new Date).getMonth(),monthName:(new Date).toLocaleString("default",{month:"long"}),year:(new Date).getFullYear()};a=t.posts.filter((s=>s.author==e._id)),o=t.pages.filter((s=>s.author==e._id)),s.render("account.html",{root:".",user:t.user,date:r,posts:a,pages:o,all_authors:t.all_authors,all_categories:t.all_categories})}))}else s.redirect("/login-na")})),router.get("/new-post",(async(e,s)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let t=e.session.passport.user;User.findById(t).then((e=>{let t=[];const o=axios.get("http://localhost:5920/category/").then((e=>e.data));let a=axios.get("http://localhost:5920/user/").then((e=>e.data.map((e=>({name:e.display_name,id:e._id})))));for(let e=0;e<o.length;e++)t.push(o[e].name);s.render("editor.html",{root:".",post:{title:"Untitled Post",meta_title:"",meta_description:"",meta_keywords:[],author:"",slug:"",content:"",categories:[],tags:[],scheduled_date:"",status:"draft",featured_image:""},type:"post",user:e,all_categories:t,all_authors:a})})).catch((e=>{s.redirect("/login")}))}else s.redirect("/login-na")})),router.get("/new-page",(async(e,s)=>{e.session.passport&&"worm"!=e.session.passport.permissions||s.redirect("/login-na")})),router.get("/edit/post/:id",(async(e,s)=>{e.session.passport&&"worm"!=e.session.passport.permissions||s.redirect("/login-na")})),router.get("/edit/page/:id",(async(e,s)=>{e.session.passport&&"worm"!=e.session.passport.permissions||s.redirect("/login-na")}));export default router;