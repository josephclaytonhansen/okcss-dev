import axios from"axios";import User from"../models/userModel.min.js";import Post from"../models/postModel.min.js";import fs from"fs";import express from"express";const router=express.Router();router.get("/dashboard",(async(e,s)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let t=e.session.passport.user,a=null;if(e.session.user)a=e.session.user;else{let s=await User.findById(t).then((e=>e));e.session.user=s}let o=null,i=null;e.session.categories?(o=e.session.categories,i=o.map((e=>({name:e.name,id:e._id})))):(o=await axios.get("http://localhost:5920/category/"),e.session.categories=o.data,i=o.data.map((e=>({name:e.name,id:e._id}))));let r=null;e.session.posts?r=e.session.posts:(r=await axios.get("http://localhost:5920/post/"),e.session.posts=r.data);let n=null;e.session.pages?n=e.session.pages:(n=await axios.get("http://localhost:5920/page/"),e.session.pages=n.data);let l=null;e.session.comments?l=e.session.comments:(l=await axios.get("http://localhost:5920/comment/"),e.session.comments=l.data);let p=null,d=null;e.session.users?(p=e.session.users,d=p.map((e=>({name:e.display_name,id:e._id})))):(p=await axios.get("http://localhost:5920/user/"),e.session.users=p.data,d=p.data.map((e=>({name:e.display_name,id:e._id}))));let h=[];if(e.session.thumbnails)h=e.session.thumbnails;else{let s=[];await axios.get("http://localhost:5920/uploaded-media-thumbnails").then((e=>{s=e.data.slugs}));for(let e=0;e<s.length;e++)await axios.get("http://localhost:5920/uploaded-media/"+s[e]).then((e=>{h.push(e.data)}));e.session.thumbnails=h}s.render("dashboard.html",{root:".",user:a,posts:r,pages:n,comments:l,all_authors:d,all_categories:i,cached_media:h,date:{day:(new Date).getDate(),month:(new Date).getMonth(),monthName:(new Date).toLocaleString("default",{month:"long"}),year:(new Date).getFullYear()}})}else s.redirect("/login-na")})),router.get("/account",(async(e,s)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let t=await axios.get("http://localhost:5920/post/").then((e=>e.data)),a=await axios.get("http://localhost:5920/page/").then((e=>e.data));e.session.passport.user;User.findById(e.session.passport.user).then((e=>{const o={day:(new Date).getDate(),month:(new Date).getMonth(),monthName:(new Date).toLocaleString("default",{month:"long"}),year:(new Date).getFullYear()};t=t.filter((s=>s.author==e._id)),a=a.filter((s=>s.author==e._id)),s.render("account.html",{root:".",user:e,date:o,posts:t,pages:a})}))}else s.redirect("/login-na")})),router.get("/new-post",(async(e,s)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let t=e.session.passport.user;User.findById(t).then((e=>{let t=[];const a=axios.get("http://localhost:5920/category/").then((e=>e.data));let o=axios.get("http://localhost:5920/user/").then((e=>e.data.map((e=>({name:e.display_name,id:e._id})))));for(let e=0;e<a.length;e++)t.push(a[e].name);s.render("editor.html",{root:".",post:{title:"Untitled Post",meta_title:"",meta_description:"",meta_keywords:[],author:"",slug:"",content:"",categories:[],tags:[],scheduled_date:"",status:"draft",featured_image:""},type:"post",user:e,all_categories:t,all_authors:o})})).catch((e=>{s.redirect("/login")}))}else s.redirect("/login-na")})),router.get("/new-page",(async(e,s)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let t=e.session.passport.user,a=axios.get("http://localhost:5920/user/").then((e=>e.data.map((e=>({name:e.display_name,id:e._id})))));User.findById(t).then((e=>{s.render("editor.html",{root:".",post:{title:"Untitled Page",meta_title:"",meta_description:"",meta_keywords:[],author:"",slug:"",content:"",status:"draft"},type:"page",user:e,all_authors:a})})).catch((e=>{s.redirect("/login")}))}else s.redirect("/login-na")})),router.get("/edit/post/:id",(async(e,s)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let t=e.session.passport.user;const a=e.params.id;let o=[];const i=axios.get("http://localhost:5920/category/").then((e=>e.data));let r=axios.get("http://localhost:5920/user/").then((e=>e.data.map((e=>({name:e.display_name,id:e._id})))));for(let e=0;e<i.length;e++)o.push(i[e].name);let n=null,l=[];n=await axios.get("http://localhost:5920/post/"),n=n.data;for(let e=0;e<n.length;e++)l.push(n[e]._id);let p=l.indexOf(a);-1==p?s.redirect("/dashboard"):s.render("editor.html",{root:".",post:axios.get("http://localhost:5920/post/id/"+l[p]).then((e=>e.data)),type:"post",user:t,username:"served_from_express",all_categories:o,all_authors:r})}else s.redirect("/login-na")})),router.get("/edit/page/:id",(async(e,s)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let t=e.session.passport.user;User.findById(t).then((t=>{const a=e.params.id;let o=[];const i=axios.get("http://localhost:5920/category/").then((e=>e.data));let r=axios.get("http://localhost:5920/user/").then((e=>e.data.map((e=>({name:e.display_name,id:e._id})))));for(let e=0;e<i.length;e++)o.push(i[e].name);let n=axios.get("http://localhost:5920/page/").then((e=>e.data)),l=[];for(let e=0;e<n.length;e++)l.push(n[e]._id);let p=l.indexOf(a);-1==p?s.redirect("/dashboard"):s.render("editor.html",{root:".",post:axios.get("http://localhost:5920/page/id/"+l[p]).then((e=>e.data)),type:"page",user:t,all_categories:o,all_authors:r})})).catch((e=>{s.redirect("/login")}))}else s.redirect("/login-na")}));export default router;