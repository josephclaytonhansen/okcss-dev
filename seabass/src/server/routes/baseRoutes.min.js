import axios from"axios";import User from"../models/userModel.min.js";import Post from"../models/postModel.min.js";import fs from"fs";import{populate,populateNew}from"./utils/populate.min.js";import express from"express";const router=express.Router();router.get("/dashboard",(async(e,t)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let s=await populate(e,t).then((e=>e)),a=[];if(e.session.thumbnails)a=e.session.thumbnails;else{let t=[];await axios.get("http://localhost:5920/uploaded-media-thumbnails").then((e=>{t=e.data.slugs}));for(let e=0;e<t.length;e++)await axios.get("http://localhost:5920/uploaded-media/"+t[e]).then((e=>{a.push(e.data)}));e.session.thumbnails=a}t.render("dashboard.html",{root:".",user:s.user,posts:s.posts,pages:s.pages,comments:s.comments,all_authors:s.all_authors,all_categories:s.all_categories,cached_media:a,date:{day:(new Date).getDate(),month:(new Date).getMonth(),monthName:(new Date).toLocaleString("default",{month:"long"}),year:(new Date).getFullYear()}})}else t.redirect("/login-na")})),router.get("/account",(async(e,t)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let s=await populate(e,t).then((e=>e)),a=[],o=[];User.findById(s.user).then((e=>{const r={day:(new Date).getDate(),month:(new Date).getMonth(),monthName:(new Date).toLocaleString("default",{month:"long"}),year:(new Date).getFullYear()};o=s.posts.filter((t=>t.author==e._id)),a=s.pages.filter((t=>t.author==e._id)),t.render("account.html",{root:".",user:s.user,date:r,posts:o,pages:a,all_authors:s.all_authors,all_categories:s.all_categories})}))}else t.redirect("/login-na")})),router.get("/new-post",(async(e,t)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let s=await populateNew(e,t).then((e=>e));t.render("editor.html",{root:".",post:{title:"Untitled Post",meta_title:"",meta_description:"",meta_keywords:[],author:"",slug:"",content:"",categories:[],tags:[],scheduled_date:"",status:"draft",featured_image:"",history:[]},type:"post",user:s.user,all_categories:s.all_categories,all_authors:s.all_authors})}else t.redirect("/login-na")})),router.get("/new-page",(async(e,t)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let s=await populateNew(e,t).then((e=>e));t.render("editor.html",{root:".",post:{title:"Untitled Page",meta_title:"",meta_description:"",meta_keywords:[],author:"",slug:"",content:"",categories:[],tags:[],scheduled_date:"",status:"draft",featured_image:"",history:[]},type:"page",user:s.user,all_categories:s.all_categories,all_authors:s.all_authors})}else t.redirect("/login-na")})),router.get("/edit/post/:id",(async(e,t)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let s=await populate(e,t).then((e=>e)),a=s.posts.filter((t=>t._id==e.params.id)),o=[];if(e.session.thumbnails)o=e.session.thumbnails;else{let t=[];await axios.get("http://localhost:5920/uploaded-media-thumbnails").then((e=>{t=e.data.slugs}));for(let e=0;e<t.length;e++)await axios.get("http://localhost:5920/uploaded-media/"+t[e]).then((e=>{o.push(e.data)}));e.session.thumbnails=o}t.render("editor.html",{root:".",post:a,type:"post",images:o,all_categories:s.all_categories,all_authors:s.all_authors})}else t.redirect("/login-na")})),router.get("/edit/page/:id",(async(e,t)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let s=await populate(e,t).then((e=>e)),a=s.pages.filter((t=>t._id==e.params.id)),o=[];if(e.session.thumbnails)o=e.session.thumbnails;else{let t=[];await axios.get("http://localhost:5920/uploaded-media-thumbnails").then((e=>{t=e.data.slugs}));for(let e=0;e<t.length;e++)await axios.get("http://localhost:5920/uploaded-media/"+t[e]).then((e=>{o.push(e.data)}));e.session.thumbnails=o}t.render("editor.html",{root:".",post:a,type:"page",images:o,all_categories:s.all_categories,all_authors:s.all_authors})}else t.redirect("/login-na")})),router.get("/refresh-session",(async(e,t)=>{let s=await axios.get("http://localhost:5920/user/").then((e=>e.data));e.session.users=s;let a=await axios.get("http://localhost:5920/post/").then((e=>e.data));e.session.posts=a;let o=await axios.get("http://localhost:5920/page/").then((e=>e.data));e.session.pages=o;let r=await axios.get("http://localhost:5920/comment/").then((e=>e.data));e.session.comments=r;let i=await User.findById(e.session.passport.user).then((e=>e));e.session.user=i,e.session.passport.user=i,t.send("session refreshed")}));export default router;