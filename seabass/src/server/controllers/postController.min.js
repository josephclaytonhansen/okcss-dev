import asyncHandler from"../middleware/asyncHandler.min.js";import Post from"../models/postModel.min.js";const getPosts=asyncHandler((async(t,s)=>{const a=await Post.find({});s.json(a)})),getPostById=asyncHandler((async(t,s)=>{const a=await Post.findById(t.params.id);if(!a)throw s.status(404),new Error("post not found");s.json(a)})),deletePostHistory=asyncHandler((async(t,s)=>{const a=await Post.findById(t.params.id);if(!a)throw s.status(404),new Error("post not found");a.history=[];await Post.findByIdAndUpdate({_id:t.params.id},{history:a.history})?s.json({message:"post history deleted"}):s.status(400).json({message:"invalid data"})})),updatePostHistory=asyncHandler((async(t,s)=>{const a=await Post.findById(t.params.id);if(!a)throw s.status(404),new Error("post not found");a.history.push(a.content);await Post.findByIdAndUpdate({_id:t.params.id},{history:a.history})?s.json({message:"post history updated"}):s.status(400).json({message:"invalid data"})})),updatePost=asyncHandler((async(t,s)=>{const{title:a,slug:e,author:o,categories:d,tags:n,status:i,content:r,featuredImage:u,metaTitle:l,metaDescription:c,metaKeywords:p}=t.body,y=await Post.findById(t.params.id);if(!y)throw s.status(404).json({message:"post not found"}),new Error("post not found");y.title=a;await Post.findByIdAndUpdate(t.params.id,{title:a,slug:e,status:i,content:r,featured_image:u,meta_title:l,meta_description:c,meta_keywords:p})?s.json({message:"post updated"}):s.status(400).json({message:"invalid data"})})),publishPost=asyncHandler((async(t,s)=>{const a=await Post.findById(t.params.id);if(!a)throw s.status(404).json({message:"post not found"}),new Error("post not found");a.status="published";await Post.findByIdAndUpdate(t.params.id,{status:"published"})?s.json({message:"post published"}):s.status(400).json({message:"invalid data"})})),schedulePost=asyncHandler((async(t,s)=>{const a=await Post.findById(t.params.id);if(!a)throw s.status(404).json({message:"post not found"}),new Error("post not found");{a.status="scheduled";let e=new Date,o=t.body.scheduled_date.split(" ")[3],d=t.body.scheduled_date.split(" ")[1],n=t.body.scheduled_date.split(" ")[2],i=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].indexOf(d);e.setFullYear(o),e.setMonth(i),e.setDate(n),e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),e.setDate(e.getDate()+1),e=e.toISOString(),a.scheduled_date=e;await Post.findByIdAndUpdate(t.params.id,{status:"scheduled",scheduled_date:e})?s.json({message:"post scheduled"+a.scheduled_date}):s.status(400).json({message:"invalid data"})}})),unpublishPost=asyncHandler((async(t,s)=>{const a=await Post.findById(t.params.id);if(!a)throw s.status(404).json({message:"post not found"}),new Error("post not found");a.status="draft",a.scheduled_date="";await Post.findByIdAndUpdate(t.params.id,{status:"draft",scheduled_date:""})?s.json({message:"post unpublished"}):s.status(400).json({message:"invalid data"})})),deletePost=asyncHandler((async(t,s)=>{const a=await Post.findById(t.params.id);if(!a)throw s.status(404),new Error("post not found");await a.remove(),s.json({message:"post removed"})})),createPost=asyncHandler((async(t,s)=>{const{title:a,slug:e,author:o,categories:d,status:n,content:i,featuredImage:r,metaTitle:u,metaDescription:l,metaKeywords:c,scheduledDate:p}=t.body,y=await Post.create({title:a,slug:e,author:o,categories:d,status:n,content:i,featured_image:r,meta_title:u,meta_description:l,meta_keywords:c,scheduled_date:p});if(!y)throw s.status(404),new Error("post not found");s.json(y)})),getPostBySlug=asyncHandler((async(t,s)=>{const a=await Post.findOne({slug:t.params.slug});if(!a)throw s.status(404),new Error("post not found");s.json(a)}));export{getPosts,getPostById,updatePost,updatePostHistory,deletePostHistory,deletePost,createPost,getPostBySlug,publishPost,unpublishPost,schedulePost};