import asyncHandler from"../middleware/asyncHandler.min.js";import Post from"../models/postModel.min.js";const getPosts=asyncHandler((async(t,s)=>{const a=await Post.find({});s.json(a)})),getPostById=asyncHandler((async(t,s)=>{const a=await Post.findById(t.params.id);if(!a)throw s.status(404),new Error("post not found");s.json(a)})),deletePostHistory=asyncHandler((async(t,s)=>{const a=await Post.findById(t.params.id);if(!a)throw s.status(404),new Error("post not found");a.history=[];await Post.findByIdAndUpdate({_id:t.params.id},{history:a.history})?s.json({message:"post history deleted"}):s.status(400).json({message:"invalid data"})})),updatePostHistory=asyncHandler((async(t,s)=>{const a=await Post.findById(t.params.id);if(!a)throw s.status(404),new Error("post not found");a.history.push(a.content);await Post.findByIdAndUpdate({_id:t.params.id},{history:a.history})?s.json({message:"post history updated"}):s.status(400).json({message:"invalid data"})})),updatePost=asyncHandler((async(t,s)=>{const{title:a,slug:e,author:o,categories:n,tags:d,status:r,content:i,featuredImage:u,metaTitle:c,metaDescription:y,metaKeywords:l}=t.body,p=await Post.findById(t.params.id);if(!p)throw s.status(404).json({message:"post not found"}),new Error("post not found");p.title=a;await Post.findByIdAndUpdate(t.params.id,{title:a,slug:e,status:r,content:i,featured_image:u,meta_title:c,meta_description:y,meta_keywords:l})?s.json({message:"post updated"}):s.status(400).json({message:"invalid data"})})),publishPost=asyncHandler((async(t,s)=>{const a=await Post.findById(t.params.id);if(!a)throw s.status(404).json({message:"post not found"}),new Error("post not found");a.status="published";await Post.findByIdAndUpdate(t.params.id,{status:"published"})?s.json({message:"post published"}):s.status(400).json({message:"invalid data"})})),schedulePost=asyncHandler((async(t,s)=>{const a=await Post.findById(t.params.id);if(!a)throw s.status(404).json({message:"post not found"}),new Error("post not found");{a.status="scheduled";let e=new Date,o=t.body.scheduled_date.split(" ")[3],n=t.body.scheduled_date.split(" ")[1],d=t.body.scheduled_date.split(" ")[2],r=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].indexOf(n);e.setFullYear(o),e.setMonth(r),e.setDate(d),e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),e.setDate(e.getDate()+1),e=e.toISOString(),a.scheduled_date=e;await Post.findByIdAndUpdate(t.params.id,{status:"scheduled",scheduled_date:e})?s.json({message:"post scheduled"+a.scheduled_date}):s.status(400).json({message:"invalid data"})}})),unpublishPost=asyncHandler((async(t,s)=>{const a=await Post.findById(t.params.id);if(!a)throw s.status(404).json({message:"post not found"}),new Error("post not found");a.status="draft",a.scheduled_date="";await Post.findByIdAndUpdate(t.params.id,{status:"draft",scheduled_date:""})?s.json({message:"post unpublished"}):s.status(400).json({message:"invalid data"})})),deletePost=asyncHandler((async(t,s)=>{const a=await Post.findById(t.params.id);if(!a)throw s.status(404),new Error("post not found");await a.remove(),s.json({message:"post removed"})})),createPost=asyncHandler((async(t,s)=>{const{title:a,slug:e,author:o,categories:n,status:d,content:r,featuredImage:i,metaTitle:u,metaDescription:c,metaKeywords:y,scheduledDate:l}=t.body,p=await Post.create({title:a,slug:e,author:o,categories:n,status:d,content:r,featured_image:i,meta_title:u,meta_description:c,meta_keywords:y,scheduled_date:l});if(!p)throw s.status(404),new Error("post not found");s.json(p)})),getPostBySlug=asyncHandler((async(t,s)=>{const a=await Post.findOne({slug:t.params.slug});if(!a)throw s.status(404),new Error("post not found");s.json(a)})),getPostsByAuthor=asyncHandler((async(t,s)=>{const a=await Post.find({author:t.params.author});if(!a)throw s.status(404),new Error("posts not found");s.json(a)})),getPostsByStatus=asyncHandler((async(t,s)=>{const a=await Post.find({status:t.params.status});if(!a)throw s.status(404),new Error("posts not found");s.json(a)})),getPostsByCategory=asyncHandler((async(t,s)=>{const a=await Post.find({category:t.params.category});if(!a)throw s.status(404),new Error("posts not found");s.json(a)}));export{getPosts,getPostById,updatePost,updatePostHistory,deletePostHistory,deletePost,createPost,getPostBySlug,getPostsByAuthor,getPostsByStatus,getPostsByCategory,publishPost,unpublishPost,schedulePost};