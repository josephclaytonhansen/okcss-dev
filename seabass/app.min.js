import db from"./src/server/mongo.js";import express from"express";import cors from"cors";import fs from"fs";import dotenv from"dotenv";import nunjucks from"nunjucks";import rate_limit from"express-rate-limit";import axios from"axios";import upload from"./src/server/multerStorage.js";import User from"./src/server/models/userModel.min.js";import page_routes from"./src/server/routes/pageRoutes.min.js";import post_routes from"./src/server/routes/postRoutes.min.js";import user_routes from"./src/server/routes/userRoutes.min.js";import comment_routes from"./src/server/routes/commentRoutes.min.js";import category_routes from"./src/server/routes/categoriesRoutes.min.js";import static_routes from"./src/server/routes/staticRoutes.min.js";import session from"express-session";import passport from"passport";import Strategy from"passport-google-oauth20";import authMiddleware from"./src/server/middleware/authMiddleware.js";import{default as totp}from"totp-generator";import QRCode from"qrcode";import{default as base32}from"base32";import{default as connectMongoDBSession}from"connect-mongodb-session";import cookieParser from"cookie-parser";const app=express(),router=express.Router();app.use(express.urlencoded({extended:!1})),app.use(cookieParser(process.env.COOKIE_PARSER_SECRET));const MongoDBStore=connectMongoDBSession(session),store=new MongoDBStore({uri:process.env.MONGO_STRING,databaseName:"development",collection:"sessions"});app.use(session({maxAge:36e5,secret:process.env.SESSION_SECRET,resave:!1,saveUninitialized:!0,cookie:{secure:"production"==process.env.ENV,maxAge:36e5},store:store})),app.use(passport.session()),app.use(passport.initialize()),router.post("/upload-image",upload.single("streamfile"),((e,t)=>{if(!1!==authMiddleware(e,User)){if(e.fileValidationError)return t.status(400).json({message:e.fileValidationError});const s=e.file;return s?t.status(201).json({name:s.filename,path:s.path,size:s.size,type:s.type,width:s.width,height:s.height,createdAt:s.createdAt,updatedAt:s.updatedAt,alt:s.alt_text}):t.status(400).json({message:"Please upload a file"})}t.redirect("/login")})),passport.use(new Strategy({clientID:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,callbackURL:"/oauth2/redirect/google",scope:["profile","email"]},(async(e,t,s,o)=>{const r=await User.findOne({googleId:s.id});if(r)return o(null,r);return o(null,await User.create({googleId:s.id,displayName:s.displayName,firstName:s.name.givenName,lastName:s.name.familyName,image:s.photos[0].value,email:s.emails[0].value,permissions:"worm"}))}))),passport.serializeUser((async function(e,t){t(null,e.id)})),passport.deserializeUser((function(e,t){User.findById(e).then((e=>{t(null,e)}))})),dotenv.config(),app.use(express.json()),app.use(express.urlencoded({extended:!1}));const corsOptions={origin:process.env.ORIGIN,credentials:!0,optionSuccessStatus:200};app.use(cors(corsOptions)),app.options("*",cors(corsOptions)),nunjucks.configure(["src/views","src/includes","src/assets"],{autoescape:!0,express:app,watch:!0});const limiter=rate_limit({windowMs:9e5,max:400,standardHeaders:!0,legacyHeaders:!1});"production"==process.env.ENV&&app.use(limiter),app.use("/page",page_routes),app.use("/post",post_routes),app.use("/user",user_routes),app.use("/comment",comment_routes),app.use("/category",category_routes),app.use("/",static_routes),router.get("/login/federated/google",passport.authenticate("google",{scope:["profile email"]})),router.get("/logout",(async(e,t,s)=>{e.session.destroy(),await e.logout((function(e){if(e)return s(e)})),t.redirect("/login")})),router.get("/",passport.authenticate("google",{successRedirect:"/dashboard",failureRedirect:"/login"})),router.get("/oauth2/redirect/google",passport.authenticate("google",{successRedirect:"/totp-challenge",failureRedirect:"/login"})),router.get("/totp-challenge",((e,t)=>{if(e.session.passport.user){let s=e.session.passport.user,o=!1,r="";User.findById(s).then((s=>{if(o=s.totp,r=s.totpSecret,e.session.passport.email=s.email,e.session.passport.display_name=s.display_name,e.session.passport.username=s.username,e.session.passport.picture=s.picture,e.session.passport.bio=s.bio,1==o){totp(r);t.render("totp-challenge.html",{root:"."})}else{let e=s+process.env.TOTP_SECRET;e=base32.encode(e).toString().replace(/0/g,"O").replace(/1/g,"I").replace(/8/g,"B").replace(/9/g,"P").toUpperCase().replace(/[^A-Z2-7=]/g,"");let o="otpauth://totp/OklahomaCitySouthStake:"+s+"?secret="+e+"&issuer=OklahomaCitySouthStake";QRCode.toDataURL(o).then((e=>{e=e.slice(0,-1),t.render("totp.html",{qr:e,root:"."})}))}}))}})),router.post("/totp-verify",((e,t)=>{let s=e.session.passport.user,o=s+process.env.TOTP_SECRET;o=base32.encode(o).toString().replace(/0/g,"O").replace(/1/g,"I").replace(/8/g,"B").replace(/9/g,"P").toUpperCase().replace(/[^A-Z2-7=]/g,""),e.body.code==totp(o)?User.findByIdAndUpdate(s,{totp:!0,totpSecret:o}).then((e=>{t.redirect("/dashboard")})):t.redirect("/totp-challenge")})),router.get("/edit/post/:id",(async(e,t)=>{if(!1===authMiddleware(e,User))t.redirect("/login");else{const s=e.params.id;let o=[];const r=await axios.get("http://localhost:5920/category/").then((e=>e.data));for(let e=0;e<r.length;e++)o.push(r[e].name);let a=await axios.get("http://localhost:5920/post/").then((e=>e.data)),i=[];for(let e=0;e<a.length;e++)i.push(a[e]._id);let p=i.indexOf(s);-1==p?t.redirect("/dashboard"):t.render("editor.html",{root:".",post:await axios.get("http://localhost:5920/post/id/"+i[p]).then((e=>e.data)),type:"post",user:{email:e.session.passport.email,username:e.session.passport.username,displayName:e.session.passport.displayName},username:"served_from_express",all_categories:o})}})),router.get("/edit/page/:id",(async(e,t)=>{if(!1===authMiddleware(e,User))t.redirect("/login");else{const s=e.params.id;let o=[];const r=await axios.get("http://localhost:5920/category/").then((e=>e.data));for(let e=0;e<r.length;e++)o.push(r[e].name);let a=await axios.get("http://localhost:5920/page/").then((e=>e.data)),i=[];for(let e=0;e<a.length;e++)i.push(a[e]._id);let p=i.indexOf(s);-1==p?t.redirect("/dashboard"):t.render("editor.html",{root:".",post:await axios.get("http://localhost:5920/page/id/"+i[p]).then((e=>e.data)),type:"page",user:{email:e.session.passport.email,username:e.session.passport.username,displayName:e.session.passport.displayName},all_categories:o})}})),router.get("/login",((e,t)=>{t.render("login.html",{root:"."})})),router.get("/dashboard",(async(e,t)=>{if(!1===authMiddleware(e,User))t.redirect("/login");else{const s={email:e.session.passport.email,username:e.session.passport.username,display_name:e.session.passport.display_name},o=await axios.get("http://localhost:5920/category/").then((e=>e.data));let r=[];for(let e=0;e<o.length;e++)r.push(o[e].name);const a=await axios.get("http://localhost:5920/user/").then((e=>e.data));let i=[];for(let e=0;e<a.length;e++)i.push({name:a[e].display_name,id:a[e]._id});t.render("dashboard.html",{root:".",date:{day:(new Date).getDate(),month:(new Date).getMonth(),monthName:(new Date).toLocaleString("default",{month:"long"}),year:(new Date).getFullYear()},user:s,all_authors:i,all_categories:o,current_categories:r,posts:await axios.get("http://localhost:5920/post").then((e=>e.data)),pages:await axios.get("http://localhost:5920/page").then((e=>e.data)),upcoming_posts:await axios.get("http://localhost:5920/post/upcoming").then((e=>e.data)).catch((e=>[]))})}})),router.get("/account",((e,t)=>{!1===authMiddleware(e,User)?t.redirect("/login"):User.findById(e.session.passport.user).then((e=>{const s={day:(new Date).getDate(),month:(new Date).getMonth(),monthName:(new Date).toLocaleString("default",{month:"long"}),year:(new Date).getFullYear()};t.render("account.html",{root:".",user:e,date:s})})).catch((e=>{t.redirect("/login")}))})),router.get("/new-post",(async(e,t)=>{if(!1===authMiddleware(e,User))t.redirect("/login");else{let e=[];const s=await axios.get("http://localhost:5920/category/").then((e=>e.data));for(let t=0;t<s.length;t++)e.push(s[t].name);t.render("editor.html",{root:".",post:{title:"Untitled Post",meta_title:"",meta_description:"",meta_keywords:[],author:"",slug:"",content:"",categories:[],tags:[],scheduled_date:"",status:"draft",featured_image:""},type:"post",user:{email:"served_from@express.app",username:"served_from_express"},all_categories:e})}})),router.get("/new-page",(async(e,t)=>{!1===authMiddleware(e,User)?t.redirect("/login"):t.render("editor.html",{root:".",post:{title:"Untitled Page",meta_title:"",meta_description:"",meta_keywords:[],author:"",slug:"",content:"",status:"draft"},type:"page",user:{email:"served_from@express.app",username:"served_from_express"}})})),app.use("/",router),app.listen(5920,(()=>{}));