import db from"./src/server/mongo.js";import express from"express";import cors from"cors";import fs from"fs";import dotenv from"dotenv";import nunjucks from"nunjucks";import{default as nunjuckDate}from"nunjucks-date";import rate_limit from"express-rate-limit";import axios from"axios";import multer from"multer";const upload=multer({dest:"tmp/"});import sharp from"sharp";import imageSize from"image-size";import User from"./src/server/models/userModel.min.js";import page_routes from"./src/server/routes/pageRoutes.min.js";import post_routes from"./src/server/routes/postRoutes.min.js";import user_routes from"./src/server/routes/userRoutes.min.js";import comment_routes from"./src/server/routes/commentRoutes.min.js";import category_routes from"./src/server/routes/categoriesRoutes.min.js";import static_routes from"./src/server/routes/staticRoutes.min.js";import session from"express-session";import passport from"passport";import Strategy from"passport-google-oauth20";import{default as totp}from"totp-generator";import QRCode from"qrcode";import{default as base32}from"base32";import{default as connectMongoDBSession}from"connect-mongodb-session";import cookieParser from"cookie-parser";import cachedMedia from"./src/server/middleware/cachedMedia.js";const app=express(),router=express.Router();app.use(express.urlencoded({extended:!1})),app.use(cookieParser(process.env.COOKIE_PARSER_SECRET));const MongoDBStore=connectMongoDBSession(session),store=new MongoDBStore({uri:process.env.MONGO_STRING,databaseName:"development",collection:"sessions"});app.use(session({maxAge:18e6,secret:process.env.SESSION_SECRET,resave:!1,saveUninitialized:!0,cookie:{secure:"production"==process.env.ENV,maxAge:18e6},store:store})),app.use(passport.session()),app.use(passport.initialize()),passport.serializeUser((async function(e,s){s(null,e.id)})),passport.deserializeUser((function(e,s){User.findById(e).then((e=>{s(null,e)}))})),dotenv.config(),app.use(express.json()),app.use(express.urlencoded({extended:!1})),passport.use(new Strategy({clientID:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,callbackURL:"/oauth2/redirect/google",scope:["profile","email"]},(async(e,s,t,o)=>{const a=await User.findOne({googleId:t.id});if(a)return o(null,a);return o(null,await User.create({googleId:t.id,displayName:t.displayName,firstName:t.name.givenName,lastName:t.name.familyName,image:t.photos[0].value,email:t.emails[0].value,permissions:"worm"}))})));const corsOptions={origin:process.env.ORIGIN,credentials:!0,optionSuccessStatus:200};app.use(cors(corsOptions)),app.options("*",cors(corsOptions));const nenv=nunjucks.configure(["src/views","src/includes","src/assets"],{autoescape:!0,express:app,watch:!0});nunjuckDate.setDefaultFormat("MMM Do, h:mm a"),nunjuckDate.install(nenv);const limiter=rate_limit({windowMs:9e5,max:400,standardHeaders:!0,legacyHeaders:!1});"production"==process.env.ENV&&app.use(limiter),app.use("/page",page_routes),app.use("/post",post_routes),app.use("/user",user_routes),app.use("/comment",comment_routes),app.use("/category",category_routes),app.use("/",static_routes),router.post("/upload-image",upload.single("streamfile"),(async(e,s)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){if(e.fileValidationError)return s.status(400).json({message:e.fileValidationError});const t=e.file;if(!t)return s.status(400).json({message:"Please upload a file"});const o=e.file.path,a=imageSize(o),r=a.width,i=a.height;let n=null;n=r>1920?await sharp(o).resize(1920).jpeg({quality:80}).toBuffer():await sharp(o).jpeg({quality:80}).toBuffer();const p=await sharp(o).resize(200,200).jpeg({quality:60}).toBuffer(),l=n.toString("base64");let c="data:"+t.mimetype+";base64,"+l,d="data:"+t.mimetype+";base64,"+p.toString("base64");await db.collection("uploads").insertOne({image:d,width:200,height:200,filename:t.originalname,type:"image/jpeg",slug:"thumbnail-"+t.originalname.replace(/\s+/g,"-").toLowerCase(),size:d.length}),await db.collection("uploads").insertOne({image:c,width:r,height:i,filename:t.originalname,type:"image/jpeg",size:c.length,slug:t.originalname.replace(/\s+/g,"-").toLowerCase()}).then((e=>{s.redirect("/dashboard")}))}else s.redirect("/login-na")})),router.get("/uploaded-media",(async(e,s)=>{let t=await db.collection("uploads").find().toArray(),o=[],a=[];t.forEach((e=>{o.push(e._id),a.push(e.slug)})),s.json({ids:o,slugs:a})})),router.get("/uploaded-media/:slug",(async(e,s)=>{await db.collection("uploads").findOne({slug:e.params.slug}).then((e=>{e.type,e.image;s.json({image:e.image,filename:e.filename,type:e.type})}))})),router.get("/login/federated/google",passport.authenticate("google",{scope:["profile email"]})),router.get("/login-na",((e,s)=>{s.render("login.html",{root:".",message:"You are not authorized.\nContact the database admin to gain access"})})),router.get("/logout",(async(e,s,t)=>{e.session.destroy(),await e.logout((function(e){if(e)return t(e)})),s.redirect("/login")})),router.get("/",passport.authenticate("google",{successRedirect:"/dashboard",failureRedirect:"/login"})),router.get("/oauth2/redirect/google",passport.authenticate("google",{successRedirect:"/totp-challenge",failureRedirect:"/login"})),router.get("/totp-challenge",((e,s)=>{if(e.session.passport.user){let t=e.session.passport.user,o=!1,a="";User.findById(t).then((t=>{if(o=t.totp,a=t.totpSecret,e.session.passport.email=t.email,e.session.passport.display_name=t.display_name,e.session.passport.username=t.username,e.session.passport.picture=t.picture,e.session.passport.bio=t.bio,1==o){totp(a);s.render("totp-challenge.html",{root:"."})}else{let e=t.email+process.env.TOTP_SECRET;e=base32.encode(e).toString().replace(/0/g,"O").replace(/1/g,"I").replace(/8/g,"B").replace(/9/g,"P").toUpperCase().replace(/[^A-Z2-7=]/g,"");let o="otpauth://totp/OklahomaCitySouthStake:"+t+"?secret="+e+"&issuer=OklahomaCitySouthStake";QRCode.toDataURL(o,{errorCorrectionLevel:"L",type:"image/png"}).then((e=>{s.render("totp.html",{qr:e,root:"."})}))}}))}})),router.post("/totp-verify",((e,s)=>{let t=e.session.passport.user,o=t+process.env.TOTP_SECRET;o=base32.encode(o).toString().replace(/0/g,"O").replace(/1/g,"I").replace(/8/g,"B").replace(/9/g,"P").toUpperCase().replace(/[^A-Z2-7=]/g,""),e.body.code==totp(o)?User.findByIdAndUpdate(t,{totp:!0,totpSecret:o}).then((e=>{s.redirect("/logged-in")})):s.redirect("/totp-challenge")})),router.get("/logged-in",((e,s)=>{let t=e.session.passport.user;User.findById(t).then((t=>{e.session.passport.email=t.email,e.session.passport.display_name=t.display_name,e.session.passport.username=t.username,e.session.passport.picture=t.picture,e.session.passport.bio=t.bio,e.session.passport.permissions=t.permissions,!1===("worm"!==e.session.passport.permissions)?s.redirect("/login"):s.redirect("/dashboard")}))})),router.get("/edit/post/:id",(async(e,s)=>{let t=e.session.passport.user;User.findById(t).then((t=>{const o=e.params.id;let a=[];const r=axios.get("http://localhost:5920/category/").then((e=>e.data));let i=axios.get("http://localhost:5920/user/").then((e=>e.data.map((e=>({name:e.display_name,id:e._id})))));for(let e=0;e<r.length;e++)a.push(r[e].name);let n=axios.get("http://localhost:5920/post/").then((e=>e.data)),p=[];for(let e=0;e<n.length;e++)p.push(n[e]._id);let l=p.indexOf(o);-1==l?s.redirect("/dashboard"):s.render("editor.html",{root:".",post:axios.get("http://localhost:5920/post/id/"+p[l]).then((e=>e.data)),type:"post",user:t,username:"served_from_express",all_categories:a,all_authors:i})})).catch((e=>{s.redirect("/login")}))})),router.get("/edit/page/:id",(async(e,s)=>{let t=e.session.passport.user;User.findById(t).then((t=>{const o=e.params.id;let a=[];const r=axios.get("http://localhost:5920/category/").then((e=>e.data));let i=axios.get("http://localhost:5920/user/").then((e=>e.data.map((e=>({name:e.display_name,id:e._id})))));for(let e=0;e<r.length;e++)a.push(r[e].name);let n=axios.get("http://localhost:5920/page/").then((e=>e.data)),p=[];for(let e=0;e<n.length;e++)p.push(n[e]._id);let l=p.indexOf(o);-1==l?s.redirect("/dashboard"):s.render("editor.html",{root:".",post:axios.get("http://localhost:5920/page/id/"+p[l]).then((e=>e.data)),type:"page",user:t,all_categories:a,all_authors:i})})).catch((e=>{s.redirect("/login")}))})),router.get("/login",((e,s)=>{s.render("login.html",{root:"."})})),router.get("/dashboard",(async(e,s)=>{if(e.session.passport&&"worm"!=e.session.passport.permissions){let t=e.session.passport.user,o=null;if(e.session.user)o=e.session.user;else{let s=await User.findById(t).then((e=>e));e.session.user=s}let a=null,r=null;e.session.categories?(a=e.session.categories,r=a.map((e=>({name:e.name,id:e._id})))):(a=await axios.get("http://localhost:5920/category/"),e.session.categories=a.data,r=a.data.map((e=>({name:e.name,id:e._id}))));let i=null;e.session.posts?i=e.session.posts:(i=await axios.get("http://localhost:5920/post/"),e.session.posts=i.data);let n=null;e.session.pages?n=e.session.pages:(n=await axios.get("http://localhost:5920/page/"),e.session.pages=n.data);let p=null;e.session.comments?p=e.session.comments:(p=await axios.get("http://localhost:5920/comment/"),e.session.comments=p.data);let l=null,c=null;e.session.users?(l=e.session.users,c=l.map((e=>({name:e.display_name,id:e._id})))):(l=await axios.get("http://localhost:5920/user/"),e.session.users=l.data,c=l.data.map((e=>({name:e.display_name,id:e._id}))));cachedMedia(e,s).then((e=>{s.render("dashboard.html",{root:".",user:o,posts:i,pages:n,comments:p,all_authors:c,all_categories:r,cached_media:e,date:{day:(new Date).getDate(),month:(new Date).getMonth(),monthName:(new Date).toLocaleString("default",{month:"long"}),year:(new Date).getFullYear()}})}))}else s.redirect("/login-na")})),router.get("/account",((e,s)=>{let t=e.session.passport.user;User.findById(t).then((t=>{User.findById(e.session.passport.user).then((e=>{const t={day:(new Date).getDate(),month:(new Date).getMonth(),monthName:(new Date).toLocaleString("default",{month:"long"}),year:(new Date).getFullYear()};s.render("account.html",{root:".",user:e,date:t})})).catch((e=>{s.redirect("/login")}))})).catch((e=>{s.redirect("/login")}))})),router.get("/new-post",(async(e,s)=>{let t=e.session.passport.user;User.findById(t).then((e=>{let t=[];const o=axios.get("http://localhost:5920/category/").then((e=>e.data));let a=axios.get("http://localhost:5920/user/").then((e=>e.data.map((e=>({name:e.display_name,id:e._id})))));for(let e=0;e<o.length;e++)t.push(o[e].name);s.render("editor.html",{root:".",post:{title:"Untitled Post",meta_title:"",meta_description:"",meta_keywords:[],author:"",slug:"",content:"",categories:[],tags:[],scheduled_date:"",status:"draft",featured_image:""},type:"post",user:e,all_categories:t,all_authors:a})})).catch((e=>{s.redirect("/login")}))})),router.get("/new-page",(async(e,s)=>{let t=e.session.passport.user,o=axios.get("http://localhost:5920/user/").then((e=>e.data.map((e=>({name:e.display_name,id:e._id})))));User.findById(t).then((e=>{s.render("editor.html",{root:".",post:{title:"Untitled Page",meta_title:"",meta_description:"",meta_keywords:[],author:"",slug:"",content:"",status:"draft"},type:"page",user:e,all_authors:o})})).catch((e=>{s.redirect("/login")}))})),app.use("/",router),app.listen(5920,(()=>{}));